#!/bin/bash
# ae-status - Display mining status

CONFIG_FILE="/opt/ae-miner/config.json"
LOG_FILE="/opt/ae-miner/logs/miner.log"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}========================================"
echo "       A5000mine Status Report        "
echo -e "========================================${NC}"
echo ""

# Service status
echo -e "${GREEN}Mining Service:${NC}"
if systemctl is-active --quiet ae-miner; then
    echo -e "  Status: ${GREEN}RUNNING${NC}"
else
    echo -e "  Status: ${RED}STOPPED${NC}"
fi

if systemctl is-enabled --quiet ae-miner 2>/dev/null; then
    echo -e "  Auto-start: ${GREEN}ENABLED${NC}"
else
    echo -e "  Auto-start: ${YELLOW}DISABLED${NC}"
fi

echo ""

# Configuration
if [ -f "$CONFIG_FILE" ]; then
    echo -e "${GREEN}Configuration:${NC}"
    WALLET=$(jq -r '.wallet' "$CONFIG_FILE")
    WORKER=$(jq -r '.worker_name' "$CONFIG_FILE")
    POOL=$(jq -r '.pool.url' "$CONFIG_FILE")

    echo "  Wallet: ${WALLET:0:10}...${WALLET: -10}"
    echo "  Worker: $WORKER"
    echo "  Pool: $POOL"
    echo ""
fi

# GPU status
if command -v nvidia-smi >/dev/null 2>&1; then
    echo -e "${GREEN}GPU Status:${NC}"
    nvidia-smi --query-gpu=index,name,temperature.gpu,power.draw,power.limit,utilization.gpu,utilization.memory \
        --format=csv,noheader,nounits | while IFS=, read -r idx name temp power limit util_gpu util_mem; do
        echo "  GPU $idx: $name"
        echo "    Temperature: ${temp}Â°C"
        echo "    Power: ${power}W / ${limit}W"
        echo "    Utilization: GPU ${util_gpu}% | Memory ${util_mem}%"
    done
    echo ""
fi

# Recent log entries
if [ -f "$LOG_FILE" ]; then
    echo -e "${GREEN}Recent Activity:${NC}"
    tail -n 10 "$LOG_FILE" | grep -E "(Accepted|Speed|shares)" | tail -5 || echo "  No recent activity"
    echo ""
fi

# Dashboard
echo -e "${GREEN}Dashboard:${NC}"
if systemctl is-active --quiet ae-dashboard; then
    DASHBOARD_PORT=$(jq -r '.dashboard.port' "$CONFIG_FILE" 2>/dev/null || echo "8080")
    echo -e "  Status: ${GREEN}RUNNING${NC}"
    echo "  URL: http://localhost:$DASHBOARD_PORT"
else
    echo -e "  Status: ${RED}STOPPED${NC}"
fi

echo ""
echo "Commands: ae-start | ae-stop | ae-logs | ae-config"
