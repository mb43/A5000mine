#!/bin/bash
# ae-config - Configuration wizard for A5000mine

set -e

CONFIG_FILE="/opt/ae-miner/config.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[ae-config]${NC} $*"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    error "This command must be run as root (use sudo)"
    exit 1
fi

echo "========================================"
echo "    A5000mine Configuration Wizard     "
echo "========================================"
echo ""

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    error "Configuration file not found: $CONFIG_FILE"
    exit 1
fi

# Read current config
CURRENT_WALLET=$(jq -r '.wallet' "$CONFIG_FILE")
CURRENT_WORKER=$(jq -r '.worker_name' "$CONFIG_FILE")
CURRENT_POOL=$(jq -r '.pool.url' "$CONFIG_FILE")
CURRENT_POWER=$(jq -r '.gpu.power_limit' "$CONFIG_FILE")

# Wallet address
echo "Current wallet: $CURRENT_WALLET"
read -p "Enter your Aeternity wallet address (ak_...): " WALLET
if [ -z "$WALLET" ]; then
    warn "No wallet provided, keeping current: $CURRENT_WALLET"
    WALLET="$CURRENT_WALLET"
fi

# Validate wallet format
if [[ ! "$WALLET" =~ ^ak_ ]]; then
    error "Invalid wallet address format. Must start with 'ak_'"
    exit 1
fi

# Worker name
echo ""
echo "Current worker name: $CURRENT_WORKER"
read -p "Enter worker name [default: $CURRENT_WORKER]: " WORKER
if [ -z "$WORKER" ]; then
    WORKER="$CURRENT_WORKER"
fi

# Pool selection
echo ""
echo "Available mining pools:"
echo "  1) 2miners (stratum+tcp://ae.2miners.com:4040) - 1% fee [default]"
echo "  2) F2Pool (stratum+tcp://ae.f2pool.com:4040) - 2% fee"
echo "  3) Custom pool URL"
read -p "Select pool [1-3, default: 1]: " POOL_CHOICE

case "$POOL_CHOICE" in
    2)
        POOL_URL="stratum+tcp://ae.f2pool.com:4040"
        ;;
    3)
        read -p "Enter custom pool URL: " POOL_URL
        ;;
    *)
        POOL_URL="stratum+tcp://ae.2miners.com:4040"
        ;;
esac

# Power limit
echo ""
echo "Current power limit: ${CURRENT_POWER}W"
echo "Recommended: 230W (A5000 TDP)"
read -p "Enter GPU power limit in Watts [default: $CURRENT_POWER]: " POWER_LIMIT
if [ -z "$POWER_LIMIT" ]; then
    POWER_LIMIT="$CURRENT_POWER"
fi

# Validate power limit
if [ "$POWER_LIMIT" -gt 300 ]; then
    warn "Power limit $POWER_LIMIT W is very high and may damage hardware"
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Update configuration
log "Updating configuration..."
jq \
    --arg wallet "$WALLET" \
    --arg worker "$WORKER" \
    --arg pool "$POOL_URL" \
    --argjson power "$POWER_LIMIT" \
    '.wallet = $wallet | .worker_name = $worker | .pool.url = $pool | .gpu.power_limit = $power' \
    "$CONFIG_FILE" > "$CONFIG_FILE.tmp"
mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"

echo ""
log "Configuration saved successfully!"
echo ""
echo "Summary:"
echo "  Wallet: ${WALLET:0:10}...${WALLET: -10}"
echo "  Worker: $WORKER"
echo "  Pool: $POOL_URL"
echo "  Power Limit: ${POWER_LIMIT}W"
echo ""
echo "To start mining, run:"
echo "  sudo systemctl start ae-miner"
echo ""
echo "To enable auto-start on boot:"
echo "  sudo systemctl enable ae-miner"
echo ""
echo "To view status:"
echo "  ae-status"
