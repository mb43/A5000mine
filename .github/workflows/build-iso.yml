name: Build A5000mine ISO

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo df -h

      - name: Build ISO
        run: |
          sudo ./build-iso.sh

      - name: Get ISO info
        id: iso_info
        run: |
          ISO_PATH=$(ls build/a5000mine*.iso)
          ISO_SIZE=$(du -h "$ISO_PATH" | cut -f1)
          echo "iso_path=$ISO_PATH" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          echo "iso_name=$(basename $ISO_PATH)" >> $GITHUB_OUTPUT

      - name: Generate checksums
        run: |
          cd build
          sha256sum *.iso > SHA256SUMS
          md5sum *.iso > MD5SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: a5000mine-iso
          path: |
            build/*.iso
            build/SHA256SUMS
            build/MD5SUMS
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/*.iso
            build/SHA256SUMS
            build/MD5SUMS
          body: |
            ## A5000mine Live USB ISO

            **Size:** ${{ steps.iso_info.outputs.iso_size }}

            ### Download

            Download the ISO file and flash it to a USB drive (8GB+):

            ```bash
            # Verify checksum
            sha256sum -c SHA256SUMS

            # Flash to USB (replace /dev/sdX with your USB device)
            sudo dd if=${{ steps.iso_info.outputs.iso_name }} of=/dev/sdX bs=4M status=progress oflag=sync
            ```

            ### What's Included

            - Ubuntu 22.04 LTS base
            - NVIDIA driver 550
            - lolMiner 1.88 (Aeternity optimized)
            - Auto-start mining service
            - Web dashboard on port 8080
            - Management utilities (ae-config, ae-status, etc.)

            ### Quick Start

            1. Flash ISO to USB
            2. Boot from USB
            3. Run: `sudo ae-config`
            4. Enter your AE wallet address
            5. Mining starts automatically!

            ### System Requirements

            - NVIDIA A5000 GPU (24GB VRAM)
            - 8GB+ RAM recommended
            - 8GB+ USB drive or 20GB+ disk space
            - Internet connection
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
